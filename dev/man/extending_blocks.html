<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Extending Blocks · Documentation | Yao</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.039/juliamono-regular.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script><link href="../assets/indigo.css" rel="stylesheet" type="text/css"/><link href="https://yaoquantum.org/assets/favicon-light.ico" rel="icon" type="image/x-icon"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../index.html"><img src="../assets/logo.png" alt="Documentation | Yao logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../index.html">Documentation | Yao</a></span></div><form class="docs-search" action="../search.html"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../index.html">Home</a></li><li><span class="tocitem">Quick Start</span><ul><li><a class="tocitem" href="../generated/quick-start/1.prepare-ghz-state/index.html">Prepare Greenberger–Horne–Zeilinger state with Quantum Circuit</a></li><li><a class="tocitem" href="../generated/quick-start/2.qft-phase-estimation/index.html">Quantum Fourier Transformation and Phase Estimation</a></li><li><a class="tocitem" href="../generated/quick-start/3.grover-search/index.html">Grover Search</a></li><li><a class="tocitem" href="../generated/quick-start/4.shor-algorithm/index.html">Shor&#39;s Algorithm</a></li><li><a class="tocitem" href="../generated/quick-start/5.shor-9-code/index.html">Shor&#39;s 9 qubit code</a></li><li><a class="tocitem" href="../generated/quick-start/6.quantum-circuit-born-machine/index.html">Quantum Circuit Born Machine</a></li><li><a class="tocitem" href="../generated/quick-start/7.variation-quantum-eigen-solver/index.html">Variational Quantum Eigen Solver</a></li></ul></li><li><span class="tocitem">Manual</span><ul><li><a class="tocitem" href="array_registers.html">Array Registers</a></li><li><a class="tocitem" href="symbolic.html">Symbolic Computation</a></li><li><a class="tocitem" href="blocks.html">Blocks</a></li><li><a class="tocitem" href="automatic_differentiation.html">Automatic Differentiation</a></li><li><a class="tocitem" href="simplification.html">Simplification</a></li><li><a class="tocitem" href="base.html">Base</a></li><li><a class="tocitem" href="registers.html">Abstract Registers</a></li><li><a class="tocitem" href="bitbasis.html">BitBasis</a></li><li class="is-active"><a class="tocitem" href="extending_blocks.html">Extending Blocks</a><ul class="internal"><li><a class="tocitem" href="#Define-Custom-Constant-Blocks"><span>Define Custom Constant Blocks</span></a></li><li><a class="tocitem" href="#Define-Custom-Blocks"><span>Define Custom Blocks</span></a></li><li><a class="tocitem" href="#Define-the-matrix"><span>Define the matrix</span></a></li><li><a class="tocitem" href="#Define-how-blocks-are-applied-to-registers"><span>Define how blocks are applied to registers</span></a></li><li><a class="tocitem" href="#Define-Parameters"><span>Define Parameters</span></a></li><li><a class="tocitem" href="#Define-Adjoint"><span>Define Adjoint</span></a></li><li><a class="tocitem" href="#Define-Cache-Keys"><span>Define Cache Keys</span></a></li></ul></li></ul></li><li><a class="tocitem" href="../benchmarks.html">Benchmark</a></li><li><a class="tocitem" href="../dev/index.html">Developer Notes</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Manual</a></li><li class="is-active"><a href="extending_blocks.html">Extending Blocks</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href="extending_blocks.html">Extending Blocks</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/QuantumBFS/Yao.jl/blob/master/docs/src/man/extending_blocks.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Extending-Blocks"><a class="docs-heading-anchor" href="#Extending-Blocks">Extending Blocks</a><a id="Extending-Blocks-1"></a><a class="docs-heading-anchor-permalink" href="#Extending-Blocks" title="Permalink"></a></h1><p>Blocks are defined as a sub-type system inside Julia, you could extend it by defining new Julia types by subtyping abstract types we provide. But we also provide some handy tools to help you create your own blocks.</p><h2 id="Define-Custom-Constant-Blocks"><a class="docs-heading-anchor" href="#Define-Custom-Constant-Blocks">Define Custom Constant Blocks</a><a id="Define-Custom-Constant-Blocks-1"></a><a class="docs-heading-anchor-permalink" href="#Define-Custom-Constant-Blocks" title="Permalink"></a></h2><p>Constant blocks are used quite often and in numerical simulation we would expect it to be a real constant in the program, which means it won&#39;t allocate new memory when we try to get its matrix for several times, and it won&#39;t change with parameters.</p><p>In Yao, you can simply define a constant block with <a href="man/@ref"><code>@const_gate</code></a>, with the corresponding matrix:</p><pre><code class="nohighlight hljs ansi" style="display:block;"></code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; @const_gate Rand = rand(ComplexF64, 4, 4)</code><code class="nohighlight hljs ansi" style="display:block;"></code></pre><p>This will automatically create a type <code>RandGate{T}</code> and a constant binding <code>Rand</code> to the instance of <code>RandGate{ComplexF64}</code>, and it will also bind a Julia constant for the given matrix, so when you call <code>mat(Rand)</code>, no allocation will happen.</p><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; @allocated mat(Rand)</code><code class="nohighlight hljs ansi" style="display:block;">ERROR: UndefVarError: mat not defined</code></pre><p>If you want to use other data type like <code>ComplexF32</code>, you could directly call <code>Rand(ComplexF32)</code>, which will create a new instance with data type <code>ComplexF32</code>.</p><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; Rand(ComplexF32)</code><code class="nohighlight hljs ansi" style="display:block;">ERROR: UndefVarError: Rand not defined</code></pre><p>But remember this won&#39;t bind the matrix, it only binds <strong>the matrix you give</strong></p><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; @allocated mat(Rand(ComplexF32))</code><code class="nohighlight hljs ansi" style="display:block;">ERROR: UndefVarError: Rand not defined</code></pre><p>so if you want to make the matrix call <code>mat</code> for <code>ComplexF32</code> to have zero allocation as well, you need to do it explicitly.</p><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; @const_gate Rand::ComplexF32</code><code class="nohighlight hljs ansi" style="display:block;">ERROR: LoadError: UndefVarError: @const_gate not defined
in expression starting at REPL[1]:1</code></pre><h2 id="Define-Custom-Blocks"><a class="docs-heading-anchor" href="#Define-Custom-Blocks">Define Custom Blocks</a><a id="Define-Custom-Blocks-1"></a><a class="docs-heading-anchor-permalink" href="#Define-Custom-Blocks" title="Permalink"></a></h2><p>Primitive blocks are the most basic block to build a quantum circuit, if a primitive block has a certain structure, like containing tweakable parameters, it cannot be defined as a constant, thus create a new type by subtyping <a href="man/@ref"><code>PrimitiveBlock</code></a> is necessary</p><pre><code class="language-julia hljs">using YaoBlocks

mutable struct PhaseGate{T &lt;: Real} &lt;: PrimitiveBlock{1}
    theta::T
end</code></pre><p>If your insterested block is a composition of other blocks, you should define a <a href="man/@ref"><code>CompositeBlock</code></a>, e.g</p><pre><code class="language-julia hljs">struct ChainBlock{N} &lt;: CompositeBlock{N}
    blocks::Vector{AbstractBlock{N}}
end</code></pre><p>Besides types, there are several interfaces you could define for a block, but don&#39;t worry, they should just error if it doesn&#39;t work.</p><h2 id="Define-the-matrix"><a class="docs-heading-anchor" href="#Define-the-matrix">Define the matrix</a><a id="Define-the-matrix-1"></a><a class="docs-heading-anchor-permalink" href="#Define-the-matrix" title="Permalink"></a></h2><p>The matrix form of a block is the minimal requirement to make a custom block functional, defining it is super simple, e.g for phase gate:</p><pre><code class="language-julia hljs">mat(::Type{T}, gate::PhaseGate) where T = exp(T(im * gate.theta)) * Matrix{Complex{T}}(I, 2, 2)</code></pre><p>Or for composite blocks, you could just calculate the matrix by call <code>mat</code> on its subblocks.</p><pre><code class="language-julia hljs">mat(::Type{T}, c::ChainBlock) where T = prod(x-&gt;mat(T, x), reverse(c.blocks))</code></pre><p>The rest will just work, but might be slow since you didn&#39;t define any specification for this certain block.</p><h2 id="Define-how-blocks-are-applied-to-registers"><a class="docs-heading-anchor" href="#Define-how-blocks-are-applied-to-registers">Define how blocks are applied to registers</a><a id="Define-how-blocks-are-applied-to-registers-1"></a><a class="docs-heading-anchor-permalink" href="#Define-how-blocks-are-applied-to-registers" title="Permalink"></a></h2><p>Although, having its matrix is already enough for applying a block to register, we could improve the performance or dispatch to other actions by overloading <a href="blocks.html#YaoAPI.apply!-Tuple{AbstractRegister, AbstractBlock}"><code>apply!</code></a> interface, e.g we can use specialized instruction to make X gate (a builtin gate defined <code>@const_gate</code>) faster:</p><pre><code class="language-julia hljs">function apply!(r::ArrayReg, x::XGate)
    nactive(r) == 1 || throw(QubitMismatchError(&quot;register size $(nactive(r)) mismatch with block size $N&quot;))
    instruct!(matvec(r.state), Val(:X), (1, ))
    return r
end</code></pre><p>In Yao, this interface allows us to provide more aggressive specialization on different patterns of quantum circuits to accelerate the simulation etc.</p><h2 id="Define-Parameters"><a class="docs-heading-anchor" href="#Define-Parameters">Define Parameters</a><a id="Define-Parameters-1"></a><a class="docs-heading-anchor-permalink" href="#Define-Parameters" title="Permalink"></a></h2><p>If you want to use some member of the block to be parameters, you need to declare them explicitly</p><pre><code class="language-julia hljs">niparams(::Type{&lt;:PhaseGate}) = 1
getiparams(x::PhaseGate) = x.theta
setiparams!(r::PhaseGate, param::Real) = (r.theta = param; r)</code></pre><h2 id="Define-Adjoint"><a class="docs-heading-anchor" href="#Define-Adjoint">Define Adjoint</a><a id="Define-Adjoint-1"></a><a class="docs-heading-anchor-permalink" href="#Define-Adjoint" title="Permalink"></a></h2><p>Since blocks are actually quantum operators, it makes sense to call their <code>adjoint</code> as well. We provide <a href="blocks.html#YaoBlocks.Daggered"><code>Daggered</code></a> for general purpose, but some blocks may have more specific transformation rules for adjoints, e.g</p><pre><code class="language-julia hljs">Base.adjoint(x::PhaseGate) = PhaseGate(-x.theta)</code></pre><h2 id="Define-Cache-Keys"><a class="docs-heading-anchor" href="#Define-Cache-Keys">Define Cache Keys</a><a id="Define-Cache-Keys-1"></a><a class="docs-heading-anchor-permalink" href="#Define-Cache-Keys" title="Permalink"></a></h2><p>To enable cache, you should define <code>cache_key</code>, e.g for phase gate, we only cares about its phase, instead of the whole instance</p><pre><code class="language-julia hljs">cache_key(gate::PhaseGate) = gate.theta</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="bitbasis.html">« BitBasis</a><a class="docs-footer-nextpage" href="../benchmarks.html">Benchmark »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.10 on <span class="colophon-date" title="Monday 20 December 2021 00:06">Monday 20 December 2021</span>. Using Julia version 1.7.0.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
